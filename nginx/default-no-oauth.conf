
map $http_x_forwarded_proto $forwarded_scheme {
    default "$http_x_forwarded_proto";
    ""      "$scheme";
}

proxy_cache_path /tmp/cache levels=1:2 keys_zone=my_cache:10m max_size=10g
                 inactive=48h use_temp_path=off;

server {

  listen       80;
  server_name  localhost;

  listen 443 ssl http2;
  listen [::]:443 ssl http2;
  server_name localhost;

  proxy_connect_timeout       300;
  proxy_send_timeout          300;
  proxy_read_timeout          90m;
  send_timeout                300;

  gzip on;
  gzip_disable "msie6";

  gzip_vary on;
  gzip_proxied any;
  gzip_comp_level 6;
  gzip_buffers 16 8k;
  gzip_http_version 1.1;
  gzip_min_length 256;
  gzip_types text/plain text/css application/json application/javascript application/x-javascript text/xml application/xml application/xml+rss text/javascript application/vnd.ms-fontobject application/x-font-ttf font/opentype image/svg+xml image/x-icon;

  proxy_ssl_certificate /etc/nginx/sslcerts/selfsigned-cert.pem;
  proxy_ssl_certificate_key /etc/nginx/sslcerts/selfsigned-key.pem;
  proxy_ssl_verify off;

  ssl_protocols              TLSv1 TLSv1.1 TLSv1.2;
  ssl_ciphers                ECDHE-RSA-AES128-GCM-SHA256:ECDHE-ECDSA-AES128-GCM-SHA256:ECDHE-RSA-AES256-GCM-SHA384:ECDHE-ECDSA-AES256-GCM-SHA384:DHE-RSA-AES128-GCM-SHA256:DHE-DSS-AES128-GCM-SHA256:kEDH+AESGCM:ECDHE-RSA-AES128-SHA256:ECDHE-ECDSA-AES128-SHA256:ECDHE-RSA-AES128-SHA:ECDHE-ECDSA-AES128-SHA:ECDHE-RSA-AES256-SHA384:ECDHE-ECDSA-AES256-SHA384:ECDHE-RSA-AES256-SHA:ECDHE-ECDSA-AES256-SHA:DHE-RSA-AES128-SHA256:DHE-RSA-AES128-SHA:DHE-DSS-AES128-SHA256:DHE-RSA-AES256-SHA256:DHE-DSS-AES256-SHA:DHE-RSA-AES256-SHA:AES128-GCM-SHA256:AES256-GCM-SHA384:ECDHE-RSA-RC4-SHA:ECDHE-ECDSA-RC4-SHA:AES128:AES256:RC4-SHA:HIGH:!aNULL:!eNULL:!EXPORT:!DES:!3DES:!MD5:!PSK;
  ssl_prefer_server_ciphers  on;
  ssl_certificate /etc/nginx/sslcerts/selfsigned-cert.pem;
  ssl_certificate_key /etc/nginx/sslcerts/selfsigned-key.pem;

  proxy_cookie_path / "/; HTTPOnly; Secure";

  root /usr/share/nginx/html;

  location = /resources/img/compressed.mov {
    try_files $uri index.html;
  }

  location ^~ /api {

    # pass information via X-User and X-Email headers to backend,
    # requires running with --set-xauthrequest flag
    auth_request_set $user   $upstream_http_x_auth_request_user;
    auth_request_set $email  $upstream_http_x_auth_request_email;
    proxy_set_header X-User  $user;
    proxy_set_header X-Email $email;

    # if you enabled --cookie-refresh, this is needed for it to work with auth_request
    auth_request_set $auth_cookie $upstream_http_set_cookie;
    add_header Set-Cookie $auth_cookie;

    proxy_cache my_cache;
    proxy_cache_min_uses 1;
    proxy_cache_use_stale error timeout updating http_500 http_502 http_503 http_504;
    proxy_cache_background_update on;
    proxy_cache_lock on;

    proxy_ignore_headers X-Accel-Expires Expires Cache-Control Set-Cookie;
    proxy_hide_header "Set-Cookie";
    proxy_hide_header  Access-Control-Allow-Origin;
    proxy_cache_valid 200 302 48h;
    proxy_cache_valid any 60m;

    add_header Content-Security-Policy "default-src 'self'; script-src 'self' 'unsafe-inline'; img-src 'self' data: https://crunchbase-production-res.cloudinary.com/; font-src 'self' data: ; style-src 'self' 'unsafe-inline'; connect-src 'self';";
    # Header for effectively preventing framing attacks
    add_header X-Frame-Options 'SAMEORIGIN';
    # Header for not saving the cache
    add_header Cache-Control 'no-cache, no-store, must-revalidate';
    add_header Expires '0';
    add_header Pragma 'no-cache';
    # Header for strict transport security not enforced
    add_header Strict-Transport-Security "max-age=31536000; includeSubdomains; preload";
    add_header X-Content-Type-Options nosniff;
    add_header X-XSS-Protection "1; mode=block";

    proxy_pass http://facade-service-v2:8080/api;
  }

  location / {

    # pass information via X-User and X-Email headers to backend,
    # requires running with --set-xauthrequest flag
    auth_request_set $user   $upstream_http_x_auth_request_user;
    auth_request_set $email  $upstream_http_x_auth_request_email;
    proxy_set_header X-User  $user;
    proxy_set_header X-Email $email;

    # if you enabled --cookie-refresh, this is needed for it to work with auth_request
    auth_request_set $auth_cookie $upstream_http_set_cookie;
    add_header Set-Cookie $auth_cookie;

    root /usr/share/nginx/html;
    index index.html index.htm;
    try_files $uri $uri/index.html /index.html;

    # add_header Last-Modified $date_gmt;
    # add_header Cache-Control 'no-store, no-cache, must-revalidate, proxy-revalidate, max-age=0';
    # if_modified_since off;
    # expires off;
    # etag off;

    add_header Content-Security-Policy "default-src 'self'; script-src 'self' 'unsafe-inline'; img-src 'self' data: https://crunchbase-production-res.cloudinary.com/; font-src 'self' data: ; style-src 'self' 'unsafe-inline'; connect-src 'self';";
    # Header for effectively preventing framing attacks
    add_header X-Frame-Options 'SAMEORIGIN';
    # Header for not saving the cache
    add_header Cache-Control 'no-cache, no-store, must-revalidate';
    add_header Expires '0';
    add_header Pragma 'no-cache';
    # Header for strict transport security not enforced
    add_header Strict-Transport-Security "max-age=31536000; includeSubdomains; preload";
    add_header X-Content-Type-Options nosniff;
    add_header X-XSS-Protection "1; mode=block";
  }

  error_page   500 502 503 504  /50x.html;
  location = /50x.html {
      root   /usr/share/nginx/html;
  }
}

